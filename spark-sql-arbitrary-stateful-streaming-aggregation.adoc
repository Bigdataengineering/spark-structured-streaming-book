== Arbitrary Stateful Streaming Aggregation

*Arbitrary Stateful Streaming Aggregation* is a streaming aggregation query that uses the following `KeyValueGroupedDataset` operators:

* <<spark-sql-streaming-KeyValueGroupedDataset.adoc#mapGroupsWithState, mapGroupsWithState>> for implicit state logic

* <<spark-sql-streaming-KeyValueGroupedDataset.adoc#flatMapGroupsWithState, flatMapGroupsWithState>> for explicit state logic

`mapGroupsWithState` and `flatMapGroupsWithState` use <<spark-sql-streaming-GroupState.adoc#, GroupState>> as a *per-group streaming aggregation state*, i.e. created separately for every *group key* to hold a *state value* (of any type).

=== [[internals]] Internals

The most important execution step is when `InputProcessor` (of the parent <<spark-sql-streaming-FlatMapGroupsWithStateExec.adoc#, FlatMapGroupsWithStateExec>> physical operator) is requested to <<spark-sql-streaming-InputProcessor.adoc#callFunctionAndUpdateState, callFunctionAndUpdateState>> which executes the *user-defined state function* on a per-group state key object, value objects, and a <<spark-sql-streaming-GroupStateImpl.adoc#, GroupStateImpl>>.

`FlatMapGroupsWithStateExec` physical operator uses <<spark-sql-streaming-StateManager.adoc#, state managers>> that are different than <<spark-sql-streaming-StreamingAggregationStateManager.adoc#, state managers>> for <<spark-sql-streaming-aggregation.adoc#, Streaming Aggregation>>.
